pre-commit:
  parallel: true
  commands:
    prettier:
      glob: '*.{js,mjs,ts,vue,json,md,yml,yaml,css,scss,html}'
      run: pnpm format:check:staged {staged_files}
      fail_text: '❌ Code formatting issues found. Run "pnpm format" to fix them and commit again.'

    forbidden-branches:
      run: |
        BRANCH=$(git rev-parse --abbrev-ref HEAD)
        if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
          echo "❌ Direct commits to $BRANCH branch are forbidden!"
          exit 1
        fi

commit-msg:
  commands:
    conventional:
      run: |
        MSG_FILE="{1}"
        MSG="$(cat "$MSG_FILE")"
        FIRST_LINE="$(printf '%s' "$MSG" | head -n 1)"

        # Regex: optional scope, optional "!" for breaking change, and description
        REGEX="^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\([^)]+\))?(!)?: .+"

        if ! echo "$FIRST_LINE" | grep -qE "$REGEX"; then
          echo "❌ Invalid commit message!"
          echo ""
          echo "Your commit message must follow the Conventional Commits format:"
          echo "   type(optional-scope)!?: description"
          echo ""
          echo "Allowed commit types:"
          echo "   feat | fix | docs | style | refactor | perf | test | chore | build | ci"
          echo ""
          echo "Rules:"
          echo " - A type is required."
          echo " - Scope is optional but must be inside parentheses when used."
          echo " - Add '!' after type or type(scope) to indicate a BREAKING CHANGE."
          echo " - A colon + space must follow type or type(scope) or type(scope)!"
          echo " - Multi-line commit messages are allowed — only the first line must match."
          echo ""
          echo "Valid examples:"
          echo "   feat: add user authentication"
          echo "   fix(server): resolve database connection issue"
          echo "   docs: update API documentation"
          echo "   style(ui): improve layout spacing"
          echo "   refactor!: remove deprecated API endpoints"
          echo "   feat(account)!: migrate user model schema"
          echo "   perf(api): improve query performance"
          echo "   ci(github-actions): fix build pipeline"
          echo ""
          exit 1
        fi
      skip:
        - merge
        - rebase

pre-push:
  commands:
    forbidden-branches:
      run: |
        BRANCH=$(git rev-parse --abbrev-ref HEAD)
        if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
          echo "❌ Pushing to $BRANCH branch is forbidden!"
          exit 1
        fi

    eslint:
      glob: '*.{js,mjs,ts,vue}'
      run: pnpm lint:staged {staged_files}
      fail_text: '❌ ESLint found issues. Run "pnpm lint:fix" to fix them and push again.'

    typecheck:
      run: pnpm typecheck
      fail_text: '❌ TypeScript type checking failed. Please fix type errors and try again.'

post-checkout:
  commands:
    pnpm-install:
      files: git diff --name-only HEAD@{1} HEAD
      glob: '{package.json,pnpm-lock.yaml}'
      run: |
        pnpm install
        echo "⚠️  Dependencies changed - you may need to restart your dev server"

post-merge:
  commands:
    pnpm-install:
      files: git diff --name-only HEAD@{1} HEAD
      glob: '{package.json,pnpm-lock.yaml}'
      run: |
        pnpm install
        echo "⚠️  Dependencies changed - you may need to restart your dev server"

skip_output:
  - meta
  - success

colors: true
